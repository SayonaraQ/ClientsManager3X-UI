name: ðŸ”¥ Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    - name: âœ… Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ðŸš€ Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.HOST }} << EOF
          set -e

          echo "ðŸ“‚ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
          cd /home/ClientsManager3X-UI

          echo "ðŸ“¦ Ð”ÐµÐ»Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ docker-compose.yml"
          mkdir -p backups
          timestamp=$(date +"%Y%m%d%H%M%S")
          cp docker-compose.yml backups/docker-compose.yml.$timestamp

          echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹, Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5"
          ls -t backups/docker-compose.yml.* | tail -n +6 | xargs -r rm --

          echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹"
          docker compose down --remove-orphans || true

          echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´"
          git pull

          echo "ðŸ³ ÐŸÑƒÐ»Ð»Ð¸Ð¼ Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹"
          docker compose pull

          echo "ðŸš€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹"
          if docker compose up -d --build; then
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½"
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ VPN-ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
          else
            echo "âŒ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ! Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿..."
            cp backups/$(ls -t backups | head -n 1) docker-compose.yml
            docker compose up -d --build
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ VPN-ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°! Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð¾Ñ‚ÐºÐ°Ñ‚ Ð½Ð° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ."
            exit 1
          fi
        EOF
