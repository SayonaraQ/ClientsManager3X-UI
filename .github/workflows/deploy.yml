name: üî• Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    - name: ‚úÖ Checkout repository
      uses: actions/checkout@v4

    - name: üîë Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: üöÄ Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << EOF
          set -e

          echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"
          cd /home/ClientsManager3X-UI

          echo "üì¶ –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø docker-compose.yml"
          mkdir -p backups
          timestamp=$(date +"%Y%m%d%H%M%S")
          cp docker-compose.yml backups/docker-compose.yml.$timestamp

          echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5"
          if ls backups/docker-compose.yml.* 1> /dev/null 2>&1; then
            ls -t backups/docker-compose.yml.* | tail -n +6 | xargs -r rm --
          else
            echo "‚ö†Ô∏è –ë—ç–∫–∞–ø–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É"
          fi

          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
          docker compose down --remove-orphans || true

          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥"
          git pull

          echo "üê≥ –ü—É–ª–ª–∏–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã"
          docker compose pull

          echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
          if docker compose up -d --build; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="‚úÖ –£—Å–ø–µ—à–Ω—ã–π –¥–µ–ø–ª–æ–π VPN-–∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è! –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±—ç–∫–∞–ø..."
            cp backups/$(ls -t backups | head -n 1) docker-compose.yml
            docker compose up -d --build
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è VPN-–∫–ª–∏–µ–Ω—Ç–∞! –í—ã–ø–æ–ª–Ω–µ–Ω –æ—Ç–∫–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é."
            exit 1
          fi
        EOF
